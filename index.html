<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>StartList</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0c10">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{--bg:#0b0c10;--card:#12141a;--ink:#e8ecf1;--muted:#9aa6b2;--acc:#5b9cff;--grid:#1c2230}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:500 15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
      .app{max-width:960px;margin:0 auto;padding:12px}

        header{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
          h1{font-size:20px;margin:0}
            .toolbar{display:flex;flex-wrap:wrap;gap:8px}
              button,select,input[type="search"],a.ics,a.site,a.add,a.refresh{
                  background:var(--card);color:var(--ink);border:1px solid #242a38;border-radius:10px;padding:6px 10px;font-size:14px;text-decoration:none;cursor:pointer
                    }
                      button:hover,a.ics:hover,a.site:hover,a.add:hover,a.refresh:hover{border-color:#2f384b}
                        input[type="search"]{min-width:0;flex:1}

                          /* layout: Next Events FIRST */
                            .grid{display:grid;grid-template-columns:1fr;gap:10px}
                              @media (min-width:900px){.grid{grid-template-columns:1.3fr 1fr;gap:16px}}
                                .panel{background:var(--card);border:1px solid #1b2130;border-radius:14px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,.25)}

                                  /* Next Events */
                                    .aside h2{font-size:16px;margin:4px 0 8px}
                                      .list{display:flex;flex-direction:column;gap:8px}
                                        .card{background:#0f131c;border:1px solid #21293b;border-radius:12px;padding:10px}
                                          .when{color:var(--muted);font-size:13px}
                                            .title{font-size:15px;font-weight:700}
                                              .type{font-size:12px;color:#b2c1d1}
                                                .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
                                                  .badge{font-size:11px;padding:3px 6px;border-radius:8px;border:1px solid #2a3550}
                                                    .badge.info{background:#37474F;color:#fff;border:1px solid #455A64}
                                                      .btnline{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
                                                        a.ics,a.site{font-size:12px}

                                                          /* Vote bar */
                                                            .votes{display:flex;align-items:center;gap:8px;margin-top:8px}
                                                              .vbtn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;border:1px solid #2a3550;background:#131a28;color:#eaf1ff;cursor:pointer;font-size:16px;line-height:1}
                                                                .vbtn.active{border-color:#5b9cff;box-shadow:0 0 0 1px rgba(91,156,255,.35) inset}
                                                                  .score{min-width:2ch;text-align:center;font-weight:700}

                                                                    /* Calendar */
                                                                      .cal-toolbar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
                                                                        .cal-left{display:flex;align-items:center;gap:8px}
                                                                          #monthLabel{min-width:170px;text-align:center}
                                                                            .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin:2px 1px 6px;color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.4px}
                                                                              .cal-head div{text-align:center}
                                                                                .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
                                                                                  .day{position:relative;min-height:56px;padding:6px;border:1px solid var(--grid);border-radius:10px;background:linear-gradient(180deg,#12141a,#0f121a)}
                                                                                    .day.muted{color:#6b7786;opacity:.8}
                                                                                      .day .num{font-size:12px}
                                                                                        .dots{position:absolute;left:6px;bottom:6px;display:flex;gap:4px;flex-wrap:wrap}
                                                                                          .dot{width:8px;height:8px;border-radius:50%;box-shadow:0 0 0 2px rgba(0,0,0,.25)}
                                                                                            .events-pop{position:absolute;z-index:3;left:4px;right:4px;bottom:30px;background:#0c1018;border:1px solid #273146;border-radius:12px;padding:6px;display:none}
                                                                                              .day:focus-within .events-pop,.day:hover .events-pop{display:block}
                                                                                                .ev{font-size:12px;padding:4px 6px;border-radius:9px;background:#141927;border:1px solid #20283a;margin:3px 0}
                                                                                                  .ev .title{font-weight:600}
                                                                                                    .ev .meta{color:var(--muted);font-size:11px}

                                                                                                      /* Type colors */
                                                                                                        .swim{background:#2196F3;color:#fff}
                                                                                                          .run{background:#E53935;color:#fff}
                                                                                                            .bike{background:#43A047;color:#fff}
                                                                                                              .tri{background:#8E24AA;color:#fff}
                                                                                                                .other{background:#FFD166;color:#000}
                                                                                                                  .hint{color:var(--muted);font-size:12px;margin-top:6px}

                                                                                                                    /* Toast */
                                                                                                                      .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0f1522;border:1px solid #2a3550;color:#eaf1ff;padding:8px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35);font-size:13px;display:none;z-index:9999}
                                                                                                                        .toast.show{display:block;animation:fade 2.8s ease}
                                                                                                                          @keyframes fade{0%{opacity:0;transform:translate(-50%,10px)}10%{opacity:1;transform:translate(-50%,0)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-6px)}}

                                                                                                                            /* FAB */
                                                                                                                              .fab{position:fixed;right:14px;bottom:14px;background:#1a2334;color:#eaf1ff;border:1px solid #2a3550;border-radius:999px;padding:10px 14px;text-decoration:none;box-shadow:0 10px 25px rgba(0,0,0,.35);font-size:14px}
                                                                                                                                @media (min-width:900px){.fab{display:none}}
                                                                                                                                </style>
                                                                                                                                </head>
                                                                                                                                <body>
                                                                                                                                <div class="app">
                                                                                                                                  <header>
                                                                                                                                      <h1>StartList</h1>
                                                                                                                                          <div class="toolbar">
                                                                                                                                                <select id="typeFilter"><option value="">Alle Typen</option></select>
                                                                                                                                                      <input id="searchBox" type="search" placeholder="Suche…" />
                                                                                                                                                            <a id="addBtn" class="add" target="_blank" rel="noopener">Event hinzufügen</a>
                                                                                                                                                                  <a id="refreshBtn" class="refresh" title="Jetzt aktualisieren">↻</a>
                                                                                                                                                                      </div>
                                                                                                                                                                        </header>

                                                                                                                                                                          <div class="grid">
                                                                                                                                                                              <!-- Next Events FIRST -->
                                                                                                                                                                                  <aside class="panel aside">
                                                                                                                                                                                        <h2>Nächste Events</h2>
                                                                                                                                                                                              <div id="nextList" class="list" aria-live="polite"></div>
                                                                                                                                                                                                    <div class="hint" id="lastUpdated"></div>
                                                                                                                                                                                                        </aside>

                                                                                                                                                                                                            <!-- Calendar SECOND -->
                                                                                                                                                                                                                <section class="panel calendar">
                                                                                                                                                                                                                      <div class="cal-toolbar">
                                                                                                                                                                                                                              <div class="cal-left">
                                                                                                                                                                                                                                        <button id="prevBtn" aria-label="Voriger Monat">◀</button>
                                                                                                                                                                                                                                                  <div id="monthLabel" aria-live="polite"></div>
                                                                                                                                                                                                                                                            <button id="nextBtn" aria-label="Nächster Monat">▶</button>
                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                            <div class="cal-right">
                                                                                                                                                                                                                                                                                      <button id="todayBtn">Heute</button>
                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                          <div class="cal-head">
                                                                                                                                                                                                                                                                                                                  <div>Mo</div><div>Di</div><div>Mi</div><div>Do</div><div>Fr</div><div>Sa</div><div>So</div>
                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                              <div class="cal-grid" id="calGrid" role="grid" aria-label="Monat"></div>
                                                                                                                                                                                                                                                                                                                                    <div class="hint">Tipp: Hover/Tippen auf ein Datum zeigt Events. „Nächste Events“ passt sich den Filtern an.</div>
                                                                                                                                                                                                                                                                                                                                        </section>
                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                                                                                                                          <a id="fabAdd" class="fab" target="_blank" rel="noopener">＋ Event</a>
                                                                                                                                                                                                                                                                                                                                          <div id="toast" class="toast">Aktualisiert</div>

<script>
/* ========= CONFIG ========= */
const CSV_URL  = "https://docs.google.com/spreadsheets/d/1qjMcZh8LuMe7aUglPClULLGtmIR3xBpLzzQvTGbLRLg/gviz/tq?tqx=out:csv&sheet=Sheet1";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScPCj_Ek48cNRdwLCvLHDwYnJhf0lpZFVXFWKwwLu_NkS8uCA/viewform";
/* Replace with your deployed Apps Script web app URL (/exec) */
const VOTES_API = "https://script.google.com/macros/s/AKfycbyyVYdJud6psEk7RBMP07f0hcebahpGHYaGFOK9oOBdim4tb6zPUM_sknCtwuXWWDFx2g/exec";
/* Cache keys */
const CACHE_VERSION = 'v6';
const LS_TEXT   = `startlist_csv_text_${CACHE_VERSION}`;
const LS_EVENTS = `startlist_events_${CACHE_VERSION}`;
const LS_TIME   = `startlist_cached_at_${CACHE_VERSION}`;
const MY_VOTES_KEY = 'startlist_myvotes_v4';

                                                                                                                                                                                                                                                                                                                                          /* ========= READY ========= */
                                                                                                                                                                                                                                                                                                                                          document.addEventListener('DOMContentLoaded', init);

                                                                                                                                                                                                                                                                                                                                          /* ========= CSV PARSER ========= */
                                                                                                                                                                                                                                                                                                                                          function parseCSV(text){
                                                                                                                                                                                                                                                                                                                                            if(!text) return [];
                                                                                                                                                                                                                                                                                                                                              if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
                                                                                                                                                                                                                                                                                                                                                const firstLine = text.split(/\r\n|\n|\r/,1)[0] ?? '';
                                                                                                                                                                                                                                                                                                                                                  const commaCount=(firstLine.match(/,/g)||[]).length;
                                                                                                                                                                                                                                                                                                                                                    const semiCount =(firstLine.match(/;/g)||[]).length;
                                                                                                                                                                                                                                                                                                                                                      const delim = semiCount>commaCount?';':',';

                                                                                                                                                                                                                                                                                                                                                        const rows=[]; let row=[]; let cur=''; let i=0; let inQuotes=false;
                                                                                                                                                                                                                                                                                                                                                          while(i<text.length){
                                                                                                                                                                                                                                                                                                                                                              const c=text[i];
                                                                                                                                                                                                                                                                                                                                                                  if(inQuotes){
                                                                                                                                                                                                                                                                                                                                                                        if(c==='"'){ if(text[i+1]==='"'){cur+='"'; i+=2;} else {inQuotes=false; i++;} continue; }
                                                                                                                                                                                                                                                                                                                                                                              cur+=c; i++; continue;
                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                      if(c==='"'){ inQuotes=true; i++; continue; }
                                                                                                                                                                                                                                                                                                                                                                                          if(c===delim){ row.push(cur); cur=''; i++; continue; }
                                                                                                                                                                                                                                                                                                                                                                                              if(c==='\n'||c==='\r'){ row.push(cur); rows.push(row); row=[]; cur=''; if(c==='\r'&&text[i+1]==='\n') i++; i++; continue; }
                                                                                                                                                                                                                                                                                                                                                                                                  cur+=c; i++;
                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                      if(cur.length||row.length){ row.push(cur); rows.push(row); }
                                                                                                                                                                                                                                                                                                                                                                                                        return rows.filter(r=>r.length && r.some(v=>v!==''));
                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                        /* ========= DATE / UTILS ========= */
                                                                                                                                                                                                                                                                                                                                                                                                        function parseGermanDate(s){
                                                                                                                                                                                                                                                                                                                                                                                                          if(!s) return null; s=String(s).trim();
                                                                                                                                                                                                                                                                                                                                                                                                            const m=s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})/); if(m) return new Date(+m[3],+m[2]-1,+m[1]);
                                                                                                                                                                                                                                                                                                                                                                                                              return new Date(s);
                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                              function fmtDate(d){return d.toLocaleDateString('de-DE',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'});}
                                                                                                                                                                                                                                                                                                                                                                                                              function fmtDayKey(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');}
                                                                                                                                                                                                                                                                                                                                                                                                              function yyyyMMdd(d){return d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0');}
                                                                                                                                                                                                                                                                                                                                                                                                              function slug(s){return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');}
                                                                                                                                                                                                                                                                                                                                                                                                              function sanitizeUrl(u){ if(!u) return ''; if(/^www\./i.test(u)) return 'https://'+u; if(!/^https?:\/\//i.test(u)) return 'https://'+u; return u; }
                                                                                                                                                                                                                                                                                                                                                                                                              function titleCase(s){return String(s).trim().toLowerCase().replace(/\b\p{L}/gu, m=>m.toUpperCase());}

                                                                                                                                                                                                                                                                                                                                                                                                              /* revive cached dates (strings -> Date) */
                                                                                                                                                                                                                                                                                                                                                                                                              function reviveEvents(evs){ return evs.map(e => ({ ...e, date: new Date(e.date) })); }

                                                                                                                                                                                                                                                                                                                                                                                                              /* today/future filter */
                                                                                                                                                                                                                                                                                                                                                                                                              function isFutureOrToday(d){
                                                                                                                                                                                                                                                                                                                                                                                                                const today=new Date(); today.setHours(0,0,0,0);
                                                                                                                                                                                                                                                                                                                                                                                                                  const dd=new Date(d); dd.setHours(0,0,0,0);
                                                                                                                                                                                                                                                                                                                                                                                                                    return dd>=today;
                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                    /* ========= TYPES (Mehrfachwerte) ========= */
                                                                                                                                                                                                                                                                                                                                                                                                                    function parseTypes(typeStr){
                                                                                                                                                                                                                                                                                                                                                                                                                      // Split by comma, slash or semicolon; trim; drop empty
                                                                                                                                                                                                                                                                                                                                                                                                                        const raw = String(typeStr||'').split(/[;,/]/).map(s=>s.trim()).filter(Boolean);
                                                                                                                                                                                                                                                                                                                                                                                                                          // normalize + dedupe (case-insensitive)
                                                                                                                                                                                                                                                                                                                                                                                                                            const normSet = new Map(); // key lower -> original pretty label
                                                                                                                                                                                                                                                                                                                                                                                                                              for(const t of raw){
                                                                                                                                                                                                                                                                                                                                                                                                                                  const lower = t.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                      if(!normSet.has(lower)) normSet.set(lower, t);
                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                          const arr = [...normSet.entries()].map(([lower, orig]) => ({ lower, label: titleCase(orig) }));
                                                                                                                                                                                                                                                                                                                                                                                                                                            return arr; // [{lower:'schwimmen', label:'Schwimmen'}, ...]
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                            function eventHasType(evLowerWanted, ev){
                                                                                                                                                                                                                                                                                                                                                                                                                                              if(!ev.types || !ev.types.length) return false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                return ev.types.some(t => t.lower === evLowerWanted);
                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                function primaryTypeLower(ev){
                                                                                                                                                                                                                                                                                                                                                                                                                                                  return ev.types && ev.types[0] ? ev.types[0].lower : 'other';
                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* ========= FETCH ========= */
                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function fetchCSVWithTimeout(url, timeoutMs=6000){
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
                                                                                                                                                                                                                                                                                                                                                                                                                                                      try{
                                                                                                                                                                                                                                                                                                                                                                                                                                                          const res=await fetch(url,{cache:'no-store',signal:ctrl.signal});
                                                                                                                                                                                                                                                                                                                                                                                                                                                              if(!res.ok) throw new Error('HTTP '+res.status);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return await res.text();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } finally { clearTimeout(t); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /* ========= MAP ROWS → EVENTS (supports EventID, multi-Types) ========= */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function mapRowsToEvents(rows){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if(!rows.length) return [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const header=rows[0].map(h=>h.trim());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const idx={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              stamp: header.findIndex(h=>/Zeitstempel/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  date:  header.findIndex(h=>/Wann findet/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      title: header.findIndex(h=>/Eventtitel/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          type:  header.findIndex(h=>/Typ|Welcher Typ/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              info:  header.findIndex(h=>/Infos/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  dist:  header.findIndex(h=>/Distanz|Distanzen/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      site:  header.findIndex(h=>/Website/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          addr:  header.findIndex(h=>/Adresse/i.test(h)),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              eid:   header.findIndex(h=>/EventID/i.test(h))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return rows.slice(1).map(r=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const d=parseGermanDate(r[idx.date]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const title=(r[idx.title]||'').trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if(!d||!title) return null;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const typeStr = String(r[idx.type]||'').trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const types = parseTypes(typeStr);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const ev={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                date:new Date(d.getFullYear(),d.getMonth(),d.getDate()),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      title,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            type:typeStr, // original
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  types,        // normalized array
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        info:String(r[idx.info]||'').trim(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              dist:String(r[idx.dist]||'').trim(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    site:sanitizeUrl(String(r[idx.site]||'').trim()),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          addr:String(r[idx.addr]||'').trim()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const fromSheet = idx.eid>=0 ? String(r[idx.eid]||'').trim() : '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ev.eventId = fromSheet || fallbackEventId(ev, r[idx.stamp]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return ev;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }).filter(Boolean);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function fallbackEventId(ev, zeitstempel){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const base = yyyyMMdd(ev.date) + '-' + slug(ev.title);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const ts = (zeitstempel||'').trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return ts ? `${base}-${slug(ts)}` : base;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* ========= STATE ========= */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  let ALL_EVENTS=[];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  let CUR=(d=>({y:d.getFullYear(),m:d.getMonth()}))(new Date());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const $=s=>document.querySelector(s);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* votes */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  let VOTE_TOTALS={}; // eventId -> {up,down,score} (or your extended metrics)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  let MY_VOTES={};    // eventId -> -1|0|1

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  function getDeviceId(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const k='startlist_device_id';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      let id=localStorage.getItem(k);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if(!id){ id=(crypto.randomUUID&&crypto.randomUUID())||('d-'+Math.random().toString(36).slice(2)+Date.now().toString(36)); localStorage.setItem(k,id); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /* ========= RENDER: CALENDAR ========= */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function monthLabel(y,m){ return new Date(y,m,1).toLocaleDateString('de-DE',{month:'long',year:'numeric'}); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function renderCalendar(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            $('#monthLabel').textContent=monthLabel(CUR.y,CUR.m);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const grid=$('#calGrid'); grid.innerHTML='';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const start=new Date(CUR.y,CUR.m,1); start.setDate(1-((start.getDay()+6)%7));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const end=new Date(start); end.setDate(end.getDate()+41);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const q=$('#searchBox').value.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const typeSel=$('#typeFilter').value; const typeWanted = typeSel ? typeSel.toLowerCase() : '';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const evByDay=new Map();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          for(const ev of ALL_EVENTS){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if(!isFutureOrToday(ev.date)) continue; // hide past
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if(typeWanted && !eventHasType(typeWanted, ev)) continue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if(q && !(ev.title.toLowerCase().includes(q) || ev.info.toLowerCase().includes(q) || ev.dist.toLowerCase().includes(q) || ev.addr.toLowerCase().includes(q))) continue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const key=fmtDayKey(ev.date);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if(!evByDay.has(key)) evByDay.set(key,[]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  evByDay.get(key).push(ev);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const todayKey=fmtDayKey(new Date());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const key=fmtDayKey(d), inMonth=d.getMonth()===CUR.m;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const day=document.createElement('div'); day.className='day'+(inMonth?'':' muted'); day.tabIndex=0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const num=document.createElement('div'); num.className='num'; num.textContent=d.getDate();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if(key===todayKey){num.style.color='var(--acc)';num.style.fontWeight='700';}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            day.appendChild(num);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const evs=evByDay.get(key)||[];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(evs.length){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const dots=document.createElement('div'); dots.className='dots';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                evs.slice(0,4).forEach(e=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const dot=document.createElement('span');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                dot.className='dot '+colorClassFor(primaryTypeLower(e));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dots.appendChild(dot);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    day.appendChild(dots);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const pop=document.createElement('div'); pop.className='events-pop';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                evs.forEach(e=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const p=document.createElement('div'); p.className='ev';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const tally=VOTE_TOTALS[e.eventId]||{up:0,down:0,score:0};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const typeBadges = (e.types||[]).map(t=>`<span class="badge ${colorClassFor(t.lower)}">${escapeHTML(t.label)}</span>`).join(' ');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                p.innerHTML=`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="title">${escapeHTML(e.title)}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="meta">${typeBadges || '–'}${e.dist? ' • '+escapeHTML(e.dist):''}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ${e.addr? `<div class="meta">📍 ${escapeHTML(e.addr)}</div>`:''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ${e.info? `<div class="meta">${escapeHTML(e.info)}</div>`:''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ${e.site? `<div class="meta"><a href="${e.site}" target="_blank" rel="noopener" class="site">Website</a></div>`:''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="votes">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button class="vbtn ${MY_VOTES[e.eventId]===1?'active':''}" data-eid="${e.eventId}" data-v="1" title="+1">▲</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="score" id="score-${e.eventId}">${tally.score}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button class="vbtn ${MY_VOTES[e.eventId]===-1?'active':''}" data-eid="${e.eventId}" data-v="-1" title="-1">▼</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  `;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          pop.appendChild(p);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      day.appendChild(pop);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              grid.appendChild(day);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                /* ========= RENDER: NEXT EVENTS ========= */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function renderNextList(limit=10){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const list=$('#nextList'); list.innerHTML='';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const q=$('#searchBox').value.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const typeSel=$('#typeFilter').value; const typeWanted = typeSel ? typeSel.toLowerCase() : '';

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const filtered=ALL_EVENTS.filter(ev=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(!isFutureOrToday(ev.date)) return false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if(typeWanted && !eventHasType(typeWanted, ev)) return false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(q && !(ev.title.toLowerCase().includes(q)||ev.info.toLowerCase().includes(q)||ev.dist.toLowerCase().includes(q)||ev.addr.toLowerCase().includes(q))) return false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }).sort((a,b)=>a.date-b.date || a.title.localeCompare(b.title)).slice(0,limit);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(!filtered.length){list.innerHTML='<div class="card">Keine kommenden Events.</div>';return;}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              for(const ev of filtered){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const card=document.createElement('div'); card.className='card';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const tally=VOTE_TOTALS[ev.eventId]||{up:0,down:0,score:0};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const icsBlob=icsForEvent(ev); const icsUrl=URL.createObjectURL(icsBlob);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const filename=slug(ev.title)+'-'+yyyyMMdd(ev.date)+'.ics';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const typeBadges = (ev.types||[]).map(t=>`<span class="badge ${colorClassFor(t.lower)}">${escapeHTML(t.label)}</span>`).join(' ');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      card.innerHTML=`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="when">${fmtDate(ev.date)}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="title">${escapeHTML(ev.title)}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="type">${typeBadges || escapeHTML(ev.type||'–')}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ${ev.addr? `<div class="type">📍 ${escapeHTML(ev.addr)}</div>`:''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="badges">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ${ev.dist? `<span class="badge ${colorClassFor(primaryTypeLower(ev))}">${escapeHTML(ev.dist)}</span>`:''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ${ev.info? `<span class="badge info">${escapeHTML(ev.info.slice(0,60))}</span>`:''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="votes">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button class="vbtn ${MY_VOTES[ev.eventId]===1?'active':''}" data-eid="${ev.eventId}" data-v="1" title="+1">▲</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span class="score" id="score-${ev.eventId}">${tally.score}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button class="vbtn ${MY_VOTES[ev.eventId]===-1?'active':''}" data-eid="${ev.eventId}" data-v="-1" title="-1">▼</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="btnline">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <a class="ics" href="${icsUrl}" download="${filename}">.ics</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ${ev.site? `<a class="site" href="${ev.site}" target="_blank" rel="noopener">Website</a>`:''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              `;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  list.appendChild(card);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // wire vote buttons in the list
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        list.querySelectorAll('.vbtn').forEach(btn=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            btn.addEventListener('click', onVoteClick);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              /* ========= FILTER UI (collects all single categories) ========= */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              function populateTypeFilter(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const set=new Set(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ALL_EVENTS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          .filter(e=>isFutureOrToday(e.date))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .flatMap(e => (e.types||[]).map(t => t.lower))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const sel=$('#typeFilter'); const cur=sel.value.toLowerCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      sel.innerHTML='<option value="">Alle Typen</option>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        [...set].sort().forEach(lower=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const label = titleCase(lower);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const opt = document.createElement('option');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    opt.value = lower; opt.textContent = label;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sel.appendChild(opt);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(set.has(cur)) sel.value=cur; else sel.value='';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

/* ========= ICS ========= */
function icsForEvent(ev){
  if(!(ev.date instanceof Date) || isNaN(ev.date)) return new Blob(['BEGIN:VCALENDAR\r\nEND:VCALENDAR\r\n'],{type:'text/calendar'});
  const dt=yyyyMMdd(ev.date), dtEnd=yyyyMMdd(new Date(ev.date.getFullYear(),ev.date.getMonth(),ev.date.getDate()+1));
  const now=new Date();
  const uid=`${dt}-${slug(ev.title)}@startlist.local`;
  const lines=[
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//StartList//EN','CALSCALE:GREGORIAN','BEGIN:VEVENT',
    `UID:${uid}`,`DTSTAMP:${now.toISOString().replace(/[-:.]/g,'').slice(0,15)}Z`,
    `DTSTART;VALUE=DATE:${dt}`,`DTEND;VALUE=DATE:${dtEnd}`,
    `SUMMARY:${icsEscape(ev.title)}`,
    ev.addr ? `LOCATION:${icsEscape(ev.addr)}` : '',
    ev.site ? `URL:${icsEscape(ev.site)}` : '',
    `DESCRIPTION:${icsEscape([ev.type,ev.dist,ev.info,ev.site,ev.addr && ('Adresse: '+ev.addr)].filter(Boolean).join('\\n'))}`,
    'END:VEVENT','END:VCALENDAR'
  ].filter(Boolean);
  return new Blob([lines.join('\r\n')+'\r\n'],{type:'text/calendar'});
}
function icsEscape(s){return String(s).replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');}

/* ========= HELPERS ========= */
function escapeHTML(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function colorClassFor(type){const t=(type||'').toLowerCase();if(t.includes('schwimm'))return'swim';if(t.includes('lauf'))return'run';if(t.includes('rad'))return'bike';if(t.includes('tri'))return'tri';return'other';}
function showToast(msg){const el=$('#toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2800);}

/* ========= PERSISTENCE & BG UPDATE ========= */
function loadFromCache(){
  try{
    const evs=localStorage.getItem(LS_EVENTS);
    const ts =localStorage.getItem(LS_TIME);
    if(evs){
      ALL_EVENTS=reviveEvents(JSON.parse(evs));  // <-- fix: restore Date objects
      populateTypeFilter(); renderNextList(); renderCalendar();
      if(ts) $('#lastUpdated').textContent='Stand: '+new Date(+ts).toLocaleString('de-DE');
      return true;
    }
  }catch(e){ console.warn('cache read failed', e); }
  return false;
}
function saveToCache(csvText, events){
  try{
    localStorage.setItem(LS_TEXT, csvText);
    localStorage.setItem(LS_EVENTS, JSON.stringify(events));
    localStorage.setItem(LS_TIME, String(Date.now()));
    $('#lastUpdated').textContent='Stand: '+new Date().toLocaleString('de-DE');
  }catch(e){ console.warn('cache write failed', e); }
}
async function refreshInBackground(opts={showToastOnChange:true}){
  try{
    const freshText=await fetchCSVWithTimeout(CSV_URL,7000);
    const oldText=localStorage.getItem(LS_TEXT)||'';
    if(!freshText) return;
    if(freshText!==oldText){
      const rows=parseCSV(freshText);
      const events=mapRowsToEvents(rows);
      if(events.length){
        ALL_EVENTS=events;
        populateTypeFilter(); renderNextList(); renderCalendar();
        saveToCache(freshText, events);
        if(opts.showToastOnChange) showToast('Aktualisiert');
      }
    }
  }catch(e){ console.log('bg refresh skipped:', e.message||e); }
}

/* ========= VOTES API ========= */
function loadMyVotes(){ try{ MY_VOTES=JSON.parse(localStorage.getItem(MY_VOTES_KEY)||'{}'); }catch{ MY_VOTES={}; } }
function saveMyVotes(){ try{ localStorage.setItem(MY_VOTES_KEY, JSON.stringify(MY_VOTES)); }catch{} }

async function fetchTallies(){
  if(!VOTES_API) return;
  try{
    const res=await fetch(VOTES_API+'?action=tallies',{cache:'no-store'});
    const json=await res.json();
    if(json && json.ok && json.totals){
      VOTE_TOTALS=json.totals;
      // update visible scores
      for(const [eid,t] of Object.entries(VOTE_TOTALS)){
        const el=document.getElementById('score-'+eid);
        if(el) el.textContent=t.score;
      }
    }
  }catch(e){ console.log('tallies fetch failed', e); }
}

async function sendVote(eventId, vote){
  if(!VOTES_API) return;
  const deviceId=getDeviceId();
  const body=JSON.stringify({eventId,deviceId,vote}); // simple request (no preflight)
  try{
    await fetch(VOTES_API,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body
    });
  }catch(e){ console.log('vote send failed', e); }
}

function onVoteClick(e){
  const btn=e.currentTarget || e.target.closest('.vbtn');
  if(!btn) return;
  const eid=btn.getAttribute('data-eid');
  const newVote=Number(btn.getAttribute('data-v'));
  const prev=MY_VOTES[eid]||0;
  let next=newVote;
  if(prev===newVote) next=0; // toggle off

  const t=VOTE_TOTALS[eid]||(VOTE_TOTALS[eid]={up:0,down:0,score:0});
  const delta=next-prev;
  t.score+=delta;

  const scoreEl=document.getElementById('score-'+eid);
  if(scoreEl) scoreEl.textContent=t.score;

  document.querySelectorAll(`.vbtn[data-eid="${eid}"]`).forEach(b=>{
    const v=Number(b.getAttribute('data-v'));
    b.classList.toggle('active', v===next);
  });

  MY_VOTES[eid]=next; saveMyVotes();
  sendVote(eid,next);
  setTimeout(fetchTallies,1500);
}

/* ========= INIT ========= */
async function init(){
  // form links
  document.getElementById('addBtn').href=FORM_URL;
  document.getElementById('fabAdd').href=FORM_URL;

  loadMyVotes();

  // render from cache, then refresh
  const hadCache=loadFromCache();
  if(!hadCache){
    try{
      const csvText=await fetchCSVWithTimeout(CSV_URL,7000);
      const rows=parseCSV(csvText);
      ALL_EVENTS=mapRowsToEvents(rows);
      populateTypeFilter(); renderNextList(); renderCalendar();
      saveToCache(csvText, ALL_EVENTS);
    }catch(e){ console.error(e); alert('Events konnten nicht geladen werden.'); }
  }
  refreshInBackground({showToastOnChange: hadCache});

  // votes
  fetchTallies();
  setInterval(fetchTallies, 5*60*1000);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) fetchTallies(); });

  // controls
  document.getElementById('prevBtn').onclick=()=>{CUR.m--; if(CUR.m<0){CUR.m=11;CUR.y--;} renderCalendar();};
  document.getElementById('nextBtn').onclick=()=>{CUR.m++; if(CUR.m>11){CUR.m=0;CUR.y++;} renderCalendar();};
  document.getElementById('todayBtn').onclick=()=>{const d=new Date(); CUR={y:d.getFullYear(),m:d.getMonth()}; renderCalendar();};
  document.getElementById('typeFilter').onchange=()=>{ renderNextList(); renderCalendar(); };
  document.getElementById('searchBox').oninput =()=>{ renderNextList(); renderCalendar(); };
  document.getElementById('refreshBtn').onclick=()=> refreshInBackground({showToastOnChange:true});

  // delegate vote clicks everywhere (list + calendar popovers)
  document.body.addEventListener('click', (ev)=>{
    const t=ev.target.closest('.vbtn');
    if(t && t.hasAttribute('data-eid')) onVoteClick({currentTarget:t, target:t});
  });
}

/* ========= PWA SW ========= */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js',{scope:'./'}).catch(console.error);});
}
</script>
</body>
</html>

